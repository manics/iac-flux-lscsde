apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- lscsde
- flux-system
- kube-system
- serviceaccount.yaml
- ../../core

# https://fluxcd.io/flux/faq/#are-there-two-kustomization-types

# Can't patch a nested resource, need to patch the resource that creates the nested resource
# https://github.com/fluxcd/kustomize-controller/issues/1000
# https://github.com/fluxcd/flux2/discussions/2744

# flux tree kustomization -nlscsde lscsde-cluster-config
#   HelmRelease/lscsde-config/lscsde-flux
#     Kustomization/lscsde-config/certmanager

patches:
  - patch: |
      apiVersion: helm.toolkit.fluxcd.io/v2beta1
      kind: HelmRelease
      metadata:
        name: lscsde-flux
        # namespace: lscsde-config
      spec:
        postRenderers:
          - kustomize:
              patches:
                - patch: |
                    apiVersion: kustomize.toolkit.fluxcd.io/v1
                    kind: Kustomization
                    metadata:
                      name: certmanager
                      # namespace: lscsde-config
                    spec:
                      patches:
                        - patch: |
                            apiVersion: helm.toolkit.fluxcd.io/v2beta1
                            kind: HelmRelease
                            metadata:
                              name: cert-manager
                              # namespace: cert-manager
                            spec:
                              values:
                                webhook:
                                  hostNetwork: false
